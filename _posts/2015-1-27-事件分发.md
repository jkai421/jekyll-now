---
layout: post
title:事件分发
---
**事件**是指在应用程序中由于用户输入或者程序内部的某个处理逻辑完成，需要等待其它模块针对该行为
进行一些响应操作的情况，例如玩家单击了屏幕，某个角色血量低于0时触发死亡。Cocos2d-x的事件分发
系统是使用订阅者设计模式实现的。

cocos2d-x的**订阅者**对应一个EventListener子类，如果事件处理程序想要响应某个事件，会创建一
个对应的EventListener子类的实例。每个EventListener由一个回调函数，一个订阅者类型type，以及
一个listenerID组成。

事件分发器EventDispatcher可以根据事件的类型type找到对应的listenerID，从而找到所有处理该事
件的订阅者。一个事件类型由一个Event子类描述，这一信息是事件源告诉分发器自己是一个什么类型的事件，
以帮助分发器找相应的订阅者。所以事件源应用程序
只需要构造一个合适的Event类，就可以触发一个事件的分发。而对于自定义事件，也可以直接向分发器传递
一个事件名和数据对象，由EventDispatcher来构造一个EventCustom对象。

事件分发给订阅者的顺序则按照订阅者的优先级来决定，给订阅者设置优先级可以让某些元素优先处理事件，
比如对于一个触摸事件，有些时候同一个点击位置上的不同层次的UI元素都在订阅者列表中，显然最上层的元
素应该优先响应事件，这样如果需要，它可以选择使这个事件不再向后面的订阅者传递。由于大多数的订阅者
都是游戏中的UI元素，都是Node子类的实例，所以很自然地，分发优先级可以与UI元素的绘制顺序相反。这
是Cocos2d-x3.0中增加的特点。

**EventDispatcher的分发顺序是：**

1. 首先分发优先级小于0的订阅者，顺序从小到大

2. 分发Node元素关联的订阅者，顺序为反向绘制顺序

3. 分发优先级大于0的订阅者，顺序从小到大

由于订阅者的优先级可能随时发生变化，比如UI元素层级变化，为了保证分发顺序的正确，必须在优先级发生
变化后进行标记，而在事件分发前重新排序。由于这种排序代价较大，Cocos2d-x只对当前正在分发的事件
类型对应的订阅者的listenerID进行排序.
