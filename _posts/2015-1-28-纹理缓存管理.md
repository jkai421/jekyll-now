---
layout: post
title: 纹理缓存管理
---

纹理占据着游戏的大部分内存，对于纹理对内存的占用的管理直接影响游戏的性能。一方面，可以通过选择适当的图片格式或者使用压缩纹理来减少队里对内存的占用。另一方面，需要对纹理的生命周期进行管理，以便于在使用时能够实时调用，而在用完后可以及时销毁。

1. 一个纹理在使用期间应该只创建一次

2. 尽量避免动态加载纹理

##TextureCache
TextureCache是一个单例模式，对于每个Director只有一个实例。负责Cocos2d-x中纹理的创建、缓存和删除。在Cocos2d-x中，一个纹理对应一个Texture2D实例，创建一个Texture2D实例会将相应的数据加载到GPU内存中，而销毁Texture2D实例时则会将纹理数据从GPU内存中移除，这就构成了一个纹理的生命周期。

TextureCache使用引用计数管理其中的纹理，也就是Texture2D对象。所有的空闲纹理的引用计数都是1，而正在被使用的纹理的引用计数则等于使用它的元素个数加1。TextureCache开放了removeUnusedTextures()方法移除空闲纹理，removeTexture(Texture2D * texures)方法移除指定纹理，以及removeAllTextures()方法移除全部纹理。

TextureCache提供了对纹理的引用计数管理方案，但是在实际游戏中，不同场景间通常会有一些共用的纹理数据。在场景切换时，一方面，我们需要尽量移除不再使用的纹理以节约内存空间，另一方面，需要在进入场景时预加载所有需要的资源。如果只按照引用计数区分资源，会在移除空闲纹理时移除那些新场景中预加载但还未使用的纹理。为了解决这个问题Cocos2d-x维护了一张不同场景各自使用那些资源（包括纹理资源）的表格，从而在进入场景前将对应的资源的引用计数加1，而在离开场景时将对应资源的引用计数减1。

